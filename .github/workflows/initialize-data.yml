name: Initialize Lottery Data
on:
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    paths:
      - 'zip_files/**'  # ç•¶zip_filesç›®éŒ„æœ‰è®Šæ›´æ™‚è‡ªå‹•è§¸ç™¼

jobs:
  initialize-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†æäº¤æ›´æ”¹
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz
    
    - name: Run initialization script
      run: |
        echo "é–‹å§‹åˆå§‹åŒ–æ­·å²è³‡æ–™..."
        cd scripts
        python initialize.py
        echo "åˆå§‹åŒ–å®Œæˆï¼"
    
    - name: Check for changes
      id: check_changes
      run: |
        echo "æª¢æŸ¥æª”æ¡ˆè®Šæ›´..."
        git add data/
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "æª¢æ¸¬åˆ°è®Šæ›´"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "æäº¤è®Šæ›´åˆ°å€‰åº«..."
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        git commit -m "ğŸ§¹ åˆå§‹åŒ–é–‹çæ­·å²è³‡æ–™ [$(date +'%Y-%m-%d %H:%M:%S')]"
        git push origin HEAD:${{ github.ref_name }}
    
    - name: Upload data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: lottery-data-initial
        path: data/
        retention-days: 7
