name: Update Lottery Data
on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ 11:00 åŸ·è¡Œ (UTC+8 = 03:00 UTC)
    - cron: '0 3 * * *'
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼
  push:
    branches: [ main, master ]

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†æäº¤æ›´æ”¹
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz
    
    - name: Run update script
      id: update
      run: |
        echo "é–‹å§‹æ›´æ–°é–‹çŽè³‡æ–™..."
        cd scripts
        python update.py
        echo "æ›´æ–°å®Œæˆï¼"
    
    - name: Check for changes
      id: check_changes
      run: |
        echo "æª¢æŸ¥æª”æ¡ˆè®Šæ›´..."
        git add data/
        if git diff --staged --quiet; then
          echo "æ²’æœ‰æ–°è³‡æ–™"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "æª¢æ¸¬åˆ°æ–°è³‡æ–™"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        echo "æäº¤è®Šæ›´åˆ°å€‰åº«..."
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions"
        
        # å–å¾—æ›´æ–°æ‘˜è¦
        UPDATE_INFO=$(cat data/update-info.json | jq -r '.last_updated' | cut -d'T' -f1)
        git commit -m "ðŸ”„ æ›´æ–°é–‹çŽè³‡æ–™è‡³ $UPDATE_INFO [$(date +'%Y-%m-%d %H:%M:%S')]"
        
        # æŽ¨é€è®Šæ›´
        git push origin HEAD:${{ github.ref_name }}
        
        echo "âœ… è³‡æ–™å·²æˆåŠŸæ›´æ–°ä¸¦æäº¤"
    
    - name: Upload data as artifact
      uses: actions/upload-artifact@v4
      with:
        name: lottery-data-update
        path: data/
        retention-days: 7
    
    - name: Create summary
      if: always()
      run: |
        echo "## é–‹çŽè³‡æ–™æ›´æ–°å ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
          echo "âœ… **æˆåŠŸæ›´æ–°è³‡æ–™åº«**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ›´æ–°æ™‚é–“: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è³‡æ–™æª”æ¡ˆå·²è‡ªå‹•æäº¤åˆ°å€‰åº«ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **ç„¡æ–°è³‡æ–™éœ€è¦æ›´æ–°**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è³‡æ–™åº«å·²ç¶“æ˜¯æœ€æ–°ç‹€æ…‹ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
